{% extends "base.html" %}
{% block title %}Add Medical Record{% endblock %}
{% block content %}
<div class="container mt-4">
    <!-- Page Title with enhanced styling -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2 class="display-5 fw-bold text-primary">
                <i class="bi bi-file-medical-fill me-2"></i>Medical Record
            </h2>
            <p class="text-muted lead">Create a comprehensive medical record with patient information</p>
        </div>
    </div>
    
    {% if patient %}
    <!-- Enhanced Patient Information Card -->
    <div class="card mb-4 shadow-lg border-0 rounded-3 overflow-hidden">
        <div class="card-header bg-gradient-primary text-white py-3">
            <h5 class="mb-0 fw-bold"><i class="bi bi-person-badge-fill me-2"></i>Patient Information</h5>
        </div>
        <div class="card-body bg-light">
            <div class="row align-items-center">
                <div class="col-md-2 text-center mb-3 mb-md-0">
                    <div class="position-relative">
                        <img src="{% if patient.photo %}{{ patient.photo.url }}{% else %}https://via.placeholder.com/100x100?text=Patient{% endif %}" 
                             alt="{{ patient.first_name }} {{ patient.last_name }}" 
                             class="img-fluid rounded-circle border border-3 border-primary shadow" 
                             style="width: 120px; height: 120px; object-fit: cover;">
                        <span class="position-absolute bottom-0 end-0 badge rounded-pill bg-success p-2">
                            <i class="bi bi-check-circle-fill"></i>
                        </span>
                    </div>
                </div>
                <div class="col-md-5">
                    <h4 class="text-primary fw-bold mb-3" style="font-size: 1.5rem; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">{{ patient.first_name }} {{ patient.last_name }}</h4>
                    <div class="d-flex mb-2 align-items-center">
                        <div class="badge bg-primary text-white me-2 p-2" style="min-width: 70px;"><i class="bi bi-file-earmark-medical me-1"></i>MRN</div>
                        <span class="fw-semibold text-dark">{{ patient.mrn }}</span>
                    </div>
                    <div class="d-flex mb-2 align-items-center">
                        <div class="badge bg-info text-white me-2 p-2" style="min-width: 70px;"><i class="bi bi-calendar-date me-1"></i>DOB</div>
                        <span class="fw-semibold text-dark">{{ patient.date_of_birth|date:"Y-m-d" }}</span>
                    </div>
                    <div class="d-flex mb-2 align-items-center">
                        <div class="badge bg-secondary text-white me-2 p-2" style="min-width: 70px;"><i class="bi bi-gender-ambiguous me-1"></i>Gender</div>
                        <span class="fw-semibold text-dark">{{ patient.gender }}</span>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="d-flex mb-2 align-items-center">
                        <div class="badge bg-dark text-white me-2 p-2" style="min-width: 70px;"><i class="bi bi-telephone me-1"></i>Phone</div>
                        <span class="fw-semibold text-dark">{{ patient.phone_number }}</span>
                    </div>
                    <div class="d-flex mb-2 align-items-center">
                        <div class="badge bg-dark text-white me-2 p-2" style="min-width: 70px;"><i class="bi bi-geo-alt me-1"></i>Address</div>
                        <span class="fw-semibold text-dark">{{ patient.address|truncatechars:30 }}</span>
                    </div>
                    <div class="d-flex mb-2 align-items-center">
                        <div class="badge bg-success text-white me-2 p-2" style="min-width: 70px;"><i class="bi bi-person me-1"></i>Age</div>
                        <span class="fw-semibold text-dark">
                            {% if patient.age %}
                                {{ patient.age.years }} years, {{ patient.age.months }} months
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Enhanced Icon Navigation Bar -->
    <div class="card mb-4 shadow-sm border-0 rounded-3">
        <div class="card-body p-0">
            <div class="icon-bar d-flex flex-wrap justify-content-center py-3">
                <div class="icon-btn" data-section="basic-info"><i class="bi bi-person-fill"></i><span>Basic Info</span></div>
                <div class="icon-btn" data-section="admission-info"><i class="bi bi-hospital-fill"></i><span>Admission</span></div>
                <div class="icon-btn" data-section="chief-complaints"><i class="bi bi-chat-left-text"></i><span>Complaints</span></div>
                <div class="icon-btn" data-section="hpi"><i class="bi bi-file-medical"></i><span>HPI</span></div>
                <div class="icon-btn" data-section="ros"><i class="bi bi-check-circle"></i><span>ROS</span></div>
                <div class="icon-btn" data-section="health-status"><i class="bi bi-heart-pulse"></i><span>Histories</span></div>
                <div class="icon-btn" data-section="physical-exam"><i class="bi bi-stethoscope"></i><span>Exam</span></div>
                <div class="icon-btn" data-section="medical-decision"><i class="bi bi-clipboard-check"></i><span>Decision</span></div>
                <div class="icon-btn" data-section="interpretation"><i class="bi bi-graph-up"></i><span>Interpret</span></div>
                <div class="icon-btn" data-section="impression-plan"><i class="bi bi-list-check"></i><span>Plan</span></div>
                <div class="icon-btn" data-section="professional-service"><i class="bi bi-briefcase"></i><span>Service</span></div>
                <div class="icon-btn" data-section="patient-education"><i class="bi bi-book"></i><span>Education</span></div>
                <div class="icon-btn" data-section="soap-note"><i class="bi bi-journal-text"></i><span>SOAP</span></div>
            </div>
        </div>
    </div>

    <!-- Section Title -->
    <div class="d-flex align-items-center mb-3">
        <h3 class="section-title mb-0 me-2">Basic Info</h3>
        <div class="progress flex-grow-1" style="height: 2px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>

    <!-- Main Form -->
    <form method="post" id="medical-record-form" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <div id="basic-info" class="content section active">
            <div class="card mb-4 shadow-sm border-0 rounded-3">
                <div class="card-header bg-light p-3">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-person-fill me-2 text-primary"></i>Basic Information</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6 mb-3 {% if patient %}d-none{% endif %}" id="patient-selection-container">
                            <label for="{{ form.patient.id_for_label }}" class="form-label"><i class="bi bi-person me-1 text-primary"></i>Patient <span class="text-danger">*</span></label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-primary text-white"><i class="bi bi-person"></i></span>
                                {{ form.patient }}
                            </div>
                            {% if form.patient.errors %}
                                <div class="invalid-feedback d-block">{{ form.patient.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label"><i class="bi bi-person me-1 text-primary"></i>Name</label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-primary text-white"><i class="bi bi-person"></i></span>
                                {{ form.name }}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.dob.id_for_label }}" class="form-label"><i class="bi bi-calendar me-1 text-primary"></i>DOB</label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-primary text-white"><i class="bi bi-calendar"></i></span>
                                {{ form.dob }}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.location.id_for_label }}" class="form-label"><i class="bi bi-geo-alt me-1 text-primary"></i>Location</label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-primary text-white"><i class="bi bi-geo-alt"></i></span>
                                {{ form.location }}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.mrn.id_for_label }}" class="form-label"><i class="bi bi-file-earmark me-1 text-primary"></i>MRN</label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-primary text-white"><i class="bi bi-file-earmark"></i></span>
                                {{ form.mrn }}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.weight.id_for_label }}" class="form-label"><i class="bi bi-scale me-1 text-primary"></i>Weight (kg)</label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-primary text-white"><i class="bi bi-scale"></i></span>
                                {{ form.weight }}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.height.id_for_label }}" class="form-label"><i class="bi bi-rulers me-1 text-primary"></i>Height (cm)</label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-primary text-white"><i class="bi bi-rulers"></i></span>
                                {{ form.height }}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div id="bmi-container">
                                <label class="form-label"><i class="bi bi-calculator me-1 text-primary"></i>BMI</label>
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text bg-primary text-white"><i class="bi bi-calculator"></i></span>
                                    <input type="text" class="form-control" id="bmi-value" readonly>
                                    <input type="hidden" name="bmi" id="bmi-hidden">
                                </div>
                                <div class="mt-2 py-1 px-2 rounded" id="bmi-interpretation-container">
                                    <small id="bmi-interpretation"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admission-info" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-hospital-fill me-2"></i>Admission Information</h5>
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-info-circle me-1"></i>Source of History</label>
                    {{ form.source_history }}
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-people me-1"></i>Present at Bedside</label>
                    {{ form.present_at_bedside }}
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-person-lines-fill me-1"></i>Referral Source</label>
                    {{ form.referral_source }}
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-exclamation-circle me-1"></i>History Limitation</label>
                    {{ form.history_limitation }}
                </div>
            </div>
        </div>

        <div id="chief-complaints" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-chat-left-text me-2"></i>Chief Complaints</h5>
                <div class="mb-3">
                    <label for="{{ form.complaint.id_for_label }}" class="form-label"><i class="bi bi-chat-left-text me-1"></i>Chief Complaint <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-chat-left-text"></i></span>
                        {{ form.complaint }}
                    </div>
                </div>
            </div>
        </div>

        <div id="hpi" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-file-medical me-2"></i>History of Present Illness</h5>
                <div class="mb-3">
                    <label for="{{ form.hpi_onset.id_for_label }}" class="form-label">Onset</label>
                    {{ form.hpi_onset }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.hpi_location.id_for_label }}" class="form-label">Location</label>
                    {{ form.hpi_location }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.hpi_severity.id_for_label }}" class="form-label">Severity</label>
                    {{ form.hpi_severity }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.hpi_duration.id_for_label }}" class="form-label">Duration</label>
                    {{ form.hpi_duration }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.hpi_modifying_factors.id_for_label }}" class="form-label">Modifying Factors</label>
                    {{ form.hpi_modifying_factors }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.hpi_others.id_for_label }}" class="form-label">Others</label>
                    {{ form.hpi_others }}
                </div>
            </div>
        </div>

        <div id="ros" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-check-circle me-2"></i>Review of Systems</h5>
                <div class="mb-3">
                    <label class="form-label">Constitutional</label>
                    {{ form.ros_constitutional }}
                </div>
            </div>
        </div>

        <div id="health-status" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-heart-pulse me-2"></i>Medical Histories</h5>
                <div class="mb-3">
                    <label for="{{ form.past_medical_history.id_for_label }}" class="form-label"><i class="bi bi-file-medical me-1"></i>Past Medical History</label>
                    {{ form.past_medical_history }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.allergic_history.id_for_label }}" class="form-label"><i class="bi bi-exclamation-triangle me-1"></i>Allergic History</label>
                    {{ form.allergic_history }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.social_history.id_for_label }}" class="form-label"><i class="bi bi-people me-1"></i>Social History</label>
                    {{ form.social_history }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.family_history.id_for_label }}" class="form-label"><i class="bi bi-people me-1"></i>Family History</label>
                    {{ form.family_history }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.past_surgical_history.id_for_label }}" class="form-label"><i class="bi bi-scissors me-1"></i>Past Surgical History</label>
                    {{ form.past_surgical_history }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.medication_history.id_for_label }}" class="form-label"><i class="bi bi-capsule me-1"></i>Medication History</label>
                    {{ form.medication_history }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.immunization_history.id_for_label }}" class="form-label"><i class="bi bi-shield-fill me-1"></i>Immunization History</label>
                    {{ form.immunization_history }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.nutritional_history.id_for_label }}" class="form-label"><i class="bi bi-egg-fried me-1"></i>Nutritional History</label>
                    {{ form.nutritional_history }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.psychiatric_history.id_for_label }}" class="form-label"><i class="bi bi-emoji-frown me-1"></i>Psychiatric History</label>
                    {{ form.psychiatric_history }}
                </div>
            </div>
        </div>

        <div id="physical-exam" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-stethoscope me-2"></i>Physical Exam</h5>
                <div class="mb-3">
                    <label class="form-label">General</label>
                    {{ form.physical_exam_general }}
                </div>
            </div>
        </div>

        <div id="medical-decision" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-clipboard-check me-2"></i>Medical Decision</h5>
                <div class="mb-3">
                    <label for="{{ form.differential_diagnoses.id_for_label }}" class="form-label">Differential Diagnoses</label>
                    {{ form.differential_diagnoses }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.result_review.id_for_label }}" class="form-label">Result Review</label>
                    {{ form.result_review }}
                </div>
            </div>
        </div>

        <div id="interpretation" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-graph-up me-2"></i>Interpretation</h5>
                <div class="mb-3">
                    <label for="{{ form.interpretation_labs.id_for_label }}" class="form-label">Interpretation</label>
                    {{ form.interpretation_labs }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.laboratory_results.id_for_label }}" class="form-label">Laboratory Results</label>
                    {{ form.laboratory_results }}
                </div>
            </div>
        </div>

        <div id="impression-plan" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-list-check me-2"></i>Impression and Plan</h5>
                <div class="mb-3">
                    <label for="{{ form.diagnosis.id_for_label }}" class="form-label">Diagnosis</label>
                    {{ form.diagnosis }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.course.id_for_label }}" class="form-label">Course</label>
                    {{ form.course }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.orders.id_for_label }}" class="form-label">Orders</label>
                    {{ form.orders }}
                </div>
            </div>
        </div>

        <div id="professional-service" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-briefcase me-2"></i>Professional Service</h5>
                <div class="mb-3">
                    <label for="{{ form.professional_service.id_for_label }}" class="form-label">Professional Service</label>
                    {{ form.professional_service }}
                </div>
            </div>
        </div>

        <div id="patient-education" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-book me-2"></i>Patient Education</h5>
                <div class="mb-3">
                    <label for="{{ form.patient_education.id_for_label }}" class="form-label">Patient Education</label>
                    {{ form.patient_education }}
                </div>
            </div>
        </div>

        <div id="soap-note" class="content section">
            <div class="card mb-4 p-4">
                <h5 class="mb-3"><i class="bi bi-journal-text me-2"></i>SOAP Note</h5>
                <div class="mb-3">
                    <label for="{{ form.soap_note.id_for_label }}" class="form-label">SOAP Note</label>
                    {{ form.soap_note }}
                </div>
            </div>
        </div>

        <div class="text-center mt-4 mb-5">
            <button type="button" class="btn btn-outline-secondary me-2 shadow-sm" id="prev-btn" disabled>
                <i class="bi bi-arrow-left me-2"></i>Previous
            </button>
            <button type="button" class="btn btn-outline-primary me-2 shadow-sm" id="next-btn">
                <i class="bi bi-arrow-right me-2"></i>Next
            </button>
            <button type="submit" class="btn btn-success shadow-sm">
                <i class="bi bi-save me-2"></i>Save Medical Record
            </button>
        </div>
    </form>

    <div class="modal fade" id="printSettingsModal" tabindex="-1" aria-labelledby="printSettingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="printSettingsModalLabel">Print Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Select Sections to Include in PDF</h6>
                    <form id="print-form" method="post" action="{% url 'manager:medical_record_print' %}">
                        {% csrf_token %}
                        <input type="hidden" name="form_data" id="form-data">
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="basic-info" id="print-basic-info" name="sections" checked>
                            <label class="form-check-label" for="print-basic-info">Basic Info</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="admission-info" id="print-admission-info" name="sections" checked>
                            <label class="form-check-label" for="print-admission-info">Admission Info</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="chief-complaints" id="print-chief-complaints" name="sections" checked>
                            <label class="form-check-label" for="print-chief-complaints">Chief Complaints</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="hpi" id="print-hpi" name="sections" checked>
                            <label class="form-check-label" for="print-hpi">HPI</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="ros" id="print-ros" name="sections" checked>
                            <label class="form-check-label" for="print-ros">ROS</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="health-status" id="print-health-status" name="sections" checked>
                            <label class="form-check-label" for="print-health-status">Histories</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="physical-exam" id="print-physical-exam" name="sections" checked>
                            <label class="form-check-label" for="print-physical-exam">Physical Exam</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="medical-decision" id="print-medical-decision" name="sections" checked>
                            <label class="form-check-label" for="print-medical-decision">Medical Decision</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="interpretation" id="print-interpretation" name="sections" checked>
                            <label class="form-check-label" for="print-interpretation">Interpretation</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="impression-plan" id="print-impression-plan" name="sections" checked>
                            <label class="form-check-label" for="print-impression-plan">Impression and Plan</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="professional-service" id="print-professional-service" name="sections" checked>
                            <label class="form-check-label" for="print-professional-service">Professional Service</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="patient-education" id="print-patient-education" name="sections" checked>
                            <label class="form-check-label" for="print-patient-education">Patient Education</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input print-section" type="checkbox" value="soap-note" id="print-soap-note" name="sections" checked>
                            <label class="form-check-label" for="print-soap-note">SOAP Note</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="print-btn" class="btn btn-primary">Generate PDF</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Modern gradient background */
body {
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
}

/* Enhanced icon bar */
.icon-bar { 
    display: flex; 
    justify-content: center; 
    flex-wrap: wrap; 
    gap: 10px;
}

.icon-btn { 
    width: 85px; 
    height: 85px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    margin: 5px; 
    border: 1px solid #e0e0e0; 
    border-radius: 12px; 
    background-color: #ffffff; 
    transition: all 0.3s ease; 
    cursor: pointer; 
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.icon-btn:hover { 
    background-color: #f8f9ff; 
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,105,255,0.1);
    border-color: #bbdefb;
}

.icon-btn.active { 
    background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
    color: white; 
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,105,255,0.2);
    border: none;
}

.icon-btn i { 
    font-size: 24px; 
    margin-bottom: 5px; 
}

.icon-btn span {
    font-size: 12px;
    font-weight: 500;
}

/* Content sections styling */
.content { 
    display: none; 
    transition: all 0.3s ease;
}

.content.active { 
    display: block; 
    animation: fadeIn 0.5s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Section title */
.section-title { 
    font-size: 24px; 
    color: #2c3e50; 
    margin-bottom: 20px;
    font-weight: 600;
}

/* Form styling */
.form-label { 
    font-size: 14px; 
    font-weight: 600; 
    color: #455a64; 
    margin-bottom: 8px;
}

.form-control {
    border-radius: 0 6px 6px 0;
    border: 1px solid #e0e0e0;
    padding: 10px 15px;
    height: auto;
    transition: all 0.3s;
}

.form-control:focus {
    border-color: #4a90e2;
    box-shadow: 0 0 0 0.25rem rgba(74, 144, 226, 0.15);
}

.input-group-text {
    border-radius: 6px 0 0 6px;
}

/* Button styling */
.btn {
    padding: 10px 20px;
    border-radius: 6px;
    transition: all 0.3s ease;
    font-weight: 500;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.btn-primary {
    background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
    border: none;
}

.btn-success {
    background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
    border: none;
}

/* Card styling */
.card {
    transition: all 0.3s ease;
    border-radius: 12px;
    overflow: hidden;
}

.card:hover {
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

/* Background gradients */
.bg-gradient-primary {
    background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
}

/* BMI interpretation styling */
#bmi-interpretation-container {
    background-color: #f8f9fa;
    transition: all 0.3s ease;
}

#bmi-interpretation-container.underweight {
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
}

#bmi-interpretation-container.normal {
    background-color: #d4edda;
    border-left: 4px solid #28a745;
}

#bmi-interpretation-container.overweight {
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
}

#bmi-interpretation-container.obese {
    background-color: #f8d7da;
    border-left: 4px solid #dc3545;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Tab Switching Logic
    const iconButtons = document.querySelectorAll('.icon-btn');
    const contentSections = document.querySelectorAll('.content.section');
    const sectionTitle = document.querySelector('.section-title');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    let currentSectionIndex = 0;
    
    // Check if a patient is already selected and hide patient dropdown if so
    const patientCard = document.querySelector('.card.shadow-lg');
    const patientField = document.getElementById('patient-selection-container');
    if (patientCard && patientField) {
        patientField.classList.add('d-none');
    }
    
    // Function to show the current section
    function showSection(index) {
        // Hide all sections
        contentSections.forEach(section => section.classList.remove('active'));
        // Show the selected section
        contentSections[index].classList.add('active');
        
        // Update icon buttons
        iconButtons.forEach(btn => btn.classList.remove('active'));
        iconButtons[index].classList.add('active');
        
        // Update section title
        sectionTitle.textContent = iconButtons[index].querySelector('span').textContent;
        
        // Enable/disable navigation buttons
        prevBtn.disabled = (index === 0);
        nextBtn.disabled = (index === contentSections.length - 1);
        
        // Update current index
        currentSectionIndex = index;
        
        // Scroll to top of section
        window.scrollTo({
            top: document.querySelector('.section-title').offsetTop - 20,
            behavior: 'smooth'
        });
    }
    
    // Navigation button click handlers
    prevBtn.addEventListener('click', () => {
        if (currentSectionIndex > 0) {
            showSection(currentSectionIndex - 1);
        }
    });
    
    nextBtn.addEventListener('click', () => {
        if (currentSectionIndex < contentSections.length - 1) {
            showSection(currentSectionIndex + 1);
        }
    });
    
    // Icon button click handlers
    iconButtons.forEach((button, index) => {
        button.addEventListener('click', () => {
            showSection(index);
        });
    });
    
    // Initialize with the first section
    showSection(0);
    
    // Enhanced BMI Calculation Logic
    const weightInput = document.getElementById('id_weight');
    const heightInput = document.getElementById('id_height');
    const bmiValue = document.getElementById('bmi-value');
    const bmiHidden = document.getElementById('bmi-hidden');
    const bmiInterpretation = document.getElementById('bmi-interpretation');
    const bmiContainer = document.getElementById('bmi-interpretation-container');
    
    function calculateBMI() {
        const weight = parseFloat(weightInput.value);
        const height = parseFloat(heightInput.value);
        
        if (weight > 0 && height > 0) {
            // Calculate BMI - weight in kg, height in meters
            const heightInMeters = height / 100;
            const bmi = weight / (heightInMeters * heightInMeters);
            const bmiRounded = Math.round(bmi * 10) / 10;
            
            // Update UI
            bmiValue.value = bmiRounded;
            bmiHidden.value = bmiRounded;
            
            // Remove all classes
            bmiContainer.classList.remove('underweight', 'normal', 'overweight', 'obese');
            
            // Interpret BMI
            let interpretation = '';
            if (bmi < 18.5) {
                interpretation = 'Underweight (BMI < 18.5)';
                bmiInterpretation.className = 'text-warning fw-bold';
                bmiContainer.classList.add('underweight');
            } else if (bmi >= 18.5 && bmi < 25) {
                interpretation = 'Normal weight (BMI 18.5-24.9)';
                bmiInterpretation.className = 'text-success fw-bold';
                bmiContainer.classList.add('normal');
            } else if (bmi >= 25 && bmi < 30) {
                interpretation = 'Overweight (BMI 25-29.9)';
                bmiInterpretation.className = 'text-warning fw-bold';
                bmiContainer.classList.add('overweight');
            } else {
                interpretation = 'Obese (BMI ≥ 30)';
                bmiInterpretation.className = 'text-danger fw-bold';
                bmiContainer.classList.add('obese');
            }
            
            bmiInterpretation.textContent = interpretation;
        } else {
            // Clear BMI if inputs are invalid
            bmiValue.value = '';
            bmiHidden.value = '';
            bmiInterpretation.textContent = '';
            bmiContainer.classList.remove('underweight', 'normal', 'overweight', 'obese');
        }
    }
    
    // Calculate BMI when inputs change
    weightInput.addEventListener('input', calculateBMI);
    heightInput.addEventListener('input', calculateBMI);
    
    // Calculate BMI on page load
    calculateBMI();
    
    // Patient selection handling
    const patientSelect = document.getElementById('id_patient');
    if (patientSelect) {
        patientSelect.addEventListener('change', function() {
            const patientId = this.value;
            if (patientId) {
                // Redirect to load patient data
                window.location.href = '{% url "manager:medical_record_create" %}?patient=' + patientId;
            }
        });
    }
    
    // Form submission with validation
    const form = document.getElementById('medical-record-form');
    form.addEventListener('submit', function(e) {
        // Make sure BMI is calculated and saved before submitting
        calculateBMI();
        
        // Basic form validation
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
            
            // Find the first section with errors
            let firstErrorSection = null;
            contentSections.forEach((section, index) => {
                if (!firstErrorSection && section.querySelector(':invalid')) {
                    firstErrorSection = index;
                }
            });
            
            // Navigate to the first section with errors
            if (firstErrorSection !== null) {
                showSection(firstErrorSection);
            }
            
            // Show validation messages
            form.classList.add('was-validated');
        }
    });
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Alt + Left Arrow = Previous Section
        if (e.altKey && e.key === 'ArrowLeft' && !prevBtn.disabled) {
            prevBtn.click();
        }
        // Alt + Right Arrow = Next Section
        if (e.altKey && e.key === 'ArrowRight' && !nextBtn.disabled) {
            nextBtn.click();
        }
        // Alt + S = Submit Form
        if (e.altKey && e.key === 's') {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Enhanced BMI Calculation Logic
        function calculateBMI() {
            const weight = parseFloat($('#{{ form.weight.id_for_label }}').val());
            const height = parseFloat($('#{{ form.height.id_for_label }}').val());
            const bmiContainer = $('#bmi-interpretation-container');
            
            if (weight > 0 && height > 0) {
                // Height in meters (convert from cm)
                const heightInMeters = height / 100;
                const bmi = weight / (heightInMeters * heightInMeters);
                const bmiRounded = Math.round(bmi * 10) / 10;
                
                $('#bmi-value').val(bmiRounded);
                $('#bmi-hidden').val(bmiRounded);
                
                // Remove all classes
                bmiContainer.removeClass('underweight normal overweight obese');
                
                // Interpret BMI
                let interpretation = '';
                if (bmi < 18.5) {
                    interpretation = 'Underweight (BMI < 18.5)';
                    $('#bmi-interpretation').removeClass().addClass('text-warning fw-bold');
                    bmiContainer.addClass('underweight');
                } else if (bmi >= 18.5 && bmi < 25) {
                    interpretation = 'Normal weight (BMI 18.5-24.9)';
                    $('#bmi-interpretation').removeClass().addClass('text-success fw-bold');
                    bmiContainer.addClass('normal');
                } else if (bmi >= 25 && bmi < 30) {
                    interpretation = 'Overweight (BMI 25-29.9)';
                    $('#bmi-interpretation').removeClass().addClass('text-warning fw-bold');
                    bmiContainer.addClass('overweight');
                } else {
                    interpretation = 'Obese (BMI ≥ 30)';
                    $('#bmi-interpretation').removeClass().addClass('text-danger fw-bold');
                    bmiContainer.addClass('obese');
                }
                
                $('#bmi-interpretation').text(interpretation);
            } else {
                $('#bmi-value').val('');
                $('#bmi-hidden').val('');
                $('#bmi-interpretation').text('');
                bmiContainer.removeClass('underweight normal overweight obese');
            }
        }
        
        // Calculate BMI on page load
        calculateBMI();
        
        // Calculate BMI when weight or height changes
        $('#{{ form.weight.id_for_label }}, #{{ form.height.id_for_label }}').on('input', calculateBMI);
        
        // Add smooth animations for section transitions
        $('.icon-btn').on('click', function() {
            $('.section-title').addClass('animate__animated animate__fadeIn');
            setTimeout(function() {
                $('.section-title').removeClass('animate__animated animate__fadeIn');
            }, 500);
        });
    });
</script>
{% endblock %}